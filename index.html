<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ø¯Ø±Ø¨ Ø§Ù„ØªØ¬ÙˆÙŠØ¯ - ÙˆØ±Ø´</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
    .font-arabic { font-family: 'Amiri', serif; }
    @media (max-width: 768px) {
      button, select, input { min-height: 44px; }
    }
    html { scroll-behavior: smooth; }
    .overflow-y-auto { -webkit-overflow-scrolling: touch; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useRef } = React;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WARSH COLORS - Original scheme from user specification
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const COLORS = {
      NAQL:       '#0891b2',  // Ù†Ù‚Ù„ - Cyan
      TAQLIL:     '#ea580c',  // ØªÙ‚Ù„ÙŠÙ„ - Orange  
      TASHIL:     '#9333ea',  // ØªØ³Ù‡ÙŠÙ„ - Purple
      IBDAL:      '#ec4899',  // Ø¥Ø¨Ø¯Ø§Ù„ - Pink
      TARQIQ_RA:  '#38bdf8',  // ØªØ±Ù‚ÙŠÙ‚ Ø§Ù„Ø±Ø§Ø¡ - Light Blue
      MADD_BADAL: '#991b1b',  // Ù…Ø¯ Ø§Ù„Ø¨Ø¯Ù„ - Dark Red
      MADD_6:     '#dc2626',  // Ù…Ø¯ Ù…ØªØµÙ„/Ù…Ù†ÙØµÙ„ - Red
      GHUNNAH:    '#16a34a',  // ØºÙ†Ø© - Green
      QALQALAH:   '#2563eb',  // Ù‚Ù„Ù‚Ù„Ø© - Blue
      TAFKHEEM:   '#1d4ed8',  // ØªÙØ®ÙŠÙ… - Dark Blue
    };

    const TAFKHEEM_LETTERS = 'Ø®ØµØ¶ØºØ·Ø¸';
    const QALQALAH_LETTERS = 'Ù‚Ø·Ø¨Ø¬Ø¯';
    const MADD_LETTERS = 'Ø§ÙˆÙŠ';

    // Taqlil words in Warsh
    const TAQLIL_PATTERNS = ['Ø§Ù„ÙƒØ§ÙØ±ÙŠÙ†', 'Ø§Ù„ÙƒÙØ§Ø±', 'Ø§Ù„ØªÙˆØ±Ø§Ø©', 'Ù…ÙˆØ³Ù‰', 'Ø¹ÙŠØ³Ù‰', 'ÙŠØ­ÙŠÙ‰', 'Ø§Ù„Ù†ØµØ§Ø±Ù‰', 'Ø£Ø³Ø§Ø±Ù‰', 'Ø³ÙƒØ§Ø±Ù‰', 'ÙƒØ³Ø§Ù„Ù‰', 'Ù‡Ø¯Ù‰', 'ØªÙ‚Ù‰', 'Ø¶Ø­Ù‰', 'Ø³Ø¯Ù‰', 'Ù‚Ø±Ù‰'];

    const TAJWEED_RULES = {
      naql:       { color: COLORS.NAQL, arabic: 'Ù†Ù‚Ù„', howTo: 'Transfer vowel to hamzat wasl' },
      taqlil:     { color: COLORS.TAQLIL, arabic: 'ØªÙ‚Ù„ÙŠÙ„', howTo: 'Pronounce alif toward ya sound' },
      tashil:     { color: COLORS.TASHIL, arabic: 'ØªØ³Ù‡ÙŠÙ„', howTo: 'Soften the second hamzah' },
      ibdal:      { color: COLORS.IBDAL, arabic: 'Ø¥Ø¨Ø¯Ø§Ù„', howTo: 'Replace hamzah with madd letter' },
      tarqiq_ra:  { color: COLORS.TARQIQ_RA, arabic: 'ØªØ±Ù‚ÙŠÙ‚ Ø§Ù„Ø±Ø§Ø¡', howTo: 'Pronounce ra lightly' },
      madd_badal: { color: COLORS.MADD_BADAL, arabic: 'Ù…Ø¯ Ø§Ù„Ø¨Ø¯Ù„', howTo: '2/4/6 counts in Warsh' },
      madd_6:     { color: COLORS.MADD_6, arabic: 'Ù…Ø¯ Ù¦', howTo: '6 counts prolongation' },
      ghunnah:    { color: COLORS.GHUNNAH, arabic: 'ØºÙ†Ø©', howTo: '2 counts nasal sound' },
      qalqalah:   { color: COLORS.QALQALAH, arabic: 'Ù‚Ù„Ù‚Ù„Ø©', howTo: 'Echo/bounce sound' },
      tafkheem:   { color: COLORS.TAFKHEEM, arabic: 'ØªÙØ®ÙŠÙ…', howTo: 'Heavy/emphatic sound' },
    };

    // Map API classes to our rules
    const TAJWEED_API_MAP = {
      'madda_necessary':    'madd_6',
      'madda_obligatory':   'madd_6',
      'madda_permissible':  'madd_badal',
      'madda_normal':       'madd_badal',
      'ghunnah':            'ghunnah',
      'idgham_ghunnah':     'ghunnah',
      'idgham_shafawi':     'ghunnah',
      'ikhafa':             'ghunnah',
      'ikhafa_shafawi':     'ghunnah',
      'iqlab':              'ghunnah',
      'qalaqah':            'qalqalah',
    };

    const COLOR_LEGEND = [
      { color: COLORS.NAQL, arabic: 'Ù†Ù‚Ù„', desc: 'Cyan' },
      { color: COLORS.TAQLIL, arabic: 'ØªÙ‚Ù„ÙŠÙ„', desc: 'Orange' },
      { color: COLORS.TASHIL, arabic: 'ØªØ³Ù‡ÙŠÙ„', desc: 'Purple' },
      { color: COLORS.IBDAL, arabic: 'Ø¥Ø¨Ø¯Ø§Ù„', desc: 'Pink' },
      { color: COLORS.TARQIQ_RA, arabic: 'ØªØ±Ù‚ÙŠÙ‚ Ø§Ù„Ø±Ø§Ø¡', desc: 'Light Blue' },
      { color: COLORS.MADD_BADAL, arabic: 'Ù…Ø¯ Ø§Ù„Ø¨Ø¯Ù„', desc: 'Dark Red' },
      { color: COLORS.MADD_6, arabic: 'Ù…Ø¯ Ù¦', desc: 'Red' },
      { color: COLORS.GHUNNAH, arabic: 'ØºÙ†Ø©', desc: 'Green' },
      { color: COLORS.QALQALAH, arabic: 'Ù‚Ù„Ù‚Ù„Ø©', desc: 'Blue' },
      { color: COLORS.TAFKHEEM, arabic: 'ØªÙØ®ÙŠÙ…', desc: 'Dark Blue' },
    ];

    const RECITERS = {
      warsh_dossary: { name: 'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ (ÙˆØ±Ø´)', baseUrl: 'https://everyayah.com/data/warsh/warsh_ibrahim_aldosary_128kbps' },
      warsh_yassin: { name: 'ÙŠØ§Ø³ÙŠÙ† Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠ (ÙˆØ±Ø´)', baseUrl: 'https://everyayah.com/data/warsh/warsh_yassin_al_jazaery_64kbps' },
    };

    const SURAH_DATA = [
      null,
      { name: 'Ø§Ù„ÙØ§ØªØ­Ø©', ayahs: 7 },
      { name: 'Ø§Ù„Ø¨Ù‚Ø±Ø©', ayahs: 286 },
      { name: 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', ayahs: 200 },
      { name: 'Ø§Ù„Ù†Ø³Ø§Ø¡', ayahs: 176 },
      { name: 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', ayahs: 120 },
      { name: 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', ayahs: 165 },
      { name: 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', ayahs: 206 },
      { name: 'Ø§Ù„Ø£Ù†ÙØ§Ù„', ayahs: 75 },
      { name: 'Ø§Ù„ØªÙˆØ¨Ø©', ayahs: 129 },
      { name: 'ÙŠÙˆÙ†Ø³', ayahs: 109 },
      { name: 'Ù‡ÙˆØ¯', ayahs: 123 },
      { name: 'ÙŠÙˆØ³Ù', ayahs: 111 },
      { name: 'Ø§Ù„Ø±Ø¹Ø¯', ayahs: 43 },
      { name: 'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', ayahs: 52 },
      { name: 'Ø§Ù„Ø­Ø¬Ø±', ayahs: 99 },
      { name: 'Ø§Ù„Ù†Ø­Ù„', ayahs: 128 },
      { name: 'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡', ayahs: 111 },
      { name: 'Ø§Ù„ÙƒÙ‡Ù', ayahs: 110 },
      { name: 'Ù…Ø±ÙŠÙ…', ayahs: 98 },
      { name: 'Ø·Ù‡', ayahs: 135 },
      { name: 'Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡', ayahs: 112 },
      { name: 'Ø§Ù„Ø­Ø¬', ayahs: 78 },
      { name: 'Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†', ayahs: 118 },
      { name: 'Ø§Ù„Ù†ÙˆØ±', ayahs: 64 },
      { name: 'Ø§Ù„ÙØ±Ù‚Ø§Ù†', ayahs: 77 },
      { name: 'Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡', ayahs: 227 },
      { name: 'Ø§Ù„Ù†Ù…Ù„', ayahs: 93 },
      { name: 'Ø§Ù„Ù‚ØµØµ', ayahs: 88 },
      { name: 'Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª', ayahs: 69 },
      { name: 'Ø§Ù„Ø±ÙˆÙ…', ayahs: 60 },
      { name: 'Ù„Ù‚Ù…Ø§Ù†', ayahs: 34 },
      { name: 'Ø§Ù„Ø³Ø¬Ø¯Ø©', ayahs: 30 },
      { name: 'Ø§Ù„Ø£Ø­Ø²Ø§Ø¨', ayahs: 73 },
      { name: 'Ø³Ø¨Ø£', ayahs: 54 },
      { name: 'ÙØ§Ø·Ø±', ayahs: 45 },
      { name: 'ÙŠØ³', ayahs: 83 },
      { name: 'Ø§Ù„ØµØ§ÙØ§Øª', ayahs: 182 },
      { name: 'Øµ', ayahs: 88 },
      { name: 'Ø§Ù„Ø²Ù…Ø±', ayahs: 75 },
      { name: 'ØºØ§ÙØ±', ayahs: 85 },
      { name: 'ÙØµÙ„Øª', ayahs: 54 },
      { name: 'Ø§Ù„Ø´ÙˆØ±Ù‰', ayahs: 53 },
      { name: 'Ø§Ù„Ø²Ø®Ø±Ù', ayahs: 89 },
      { name: 'Ø§Ù„Ø¯Ø®Ø§Ù†', ayahs: 59 },
      { name: 'Ø§Ù„Ø¬Ø§Ø«ÙŠØ©', ayahs: 37 },
      { name: 'Ø§Ù„Ø£Ø­Ù‚Ø§Ù', ayahs: 35 },
      { name: 'Ù…Ø­Ù…Ø¯', ayahs: 38 },
      { name: 'Ø§Ù„ÙØªØ­', ayahs: 29 },
      { name: 'Ø§Ù„Ø­Ø¬Ø±Ø§Øª', ayahs: 18 },
      { name: 'Ù‚', ayahs: 45 },
      { name: 'Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª', ayahs: 60 },
      { name: 'Ø§Ù„Ø·ÙˆØ±', ayahs: 49 },
      { name: 'Ø§Ù„Ù†Ø¬Ù…', ayahs: 62 },
      { name: 'Ø§Ù„Ù‚Ù…Ø±', ayahs: 55 },
      { name: 'Ø§Ù„Ø±Ø­Ù…Ù†', ayahs: 78 },
      { name: 'Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©', ayahs: 96 },
      { name: 'Ø§Ù„Ø­Ø¯ÙŠØ¯', ayahs: 29 },
      { name: 'Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©', ayahs: 22 },
      { name: 'Ø§Ù„Ø­Ø´Ø±', ayahs: 24 },
      { name: 'Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©', ayahs: 13 },
      { name: 'Ø§Ù„ØµÙ', ayahs: 14 },
      { name: 'Ø§Ù„Ø¬Ù…Ø¹Ø©', ayahs: 11 },
      { name: 'Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†', ayahs: 11 },
      { name: 'Ø§Ù„ØªØºØ§Ø¨Ù†', ayahs: 18 },
      { name: 'Ø§Ù„Ø·Ù„Ø§Ù‚', ayahs: 12 },
      { name: 'Ø§Ù„ØªØ­Ø±ÙŠÙ…', ayahs: 12 },
      { name: 'Ø§Ù„Ù…Ù„Ùƒ', ayahs: 30 },
      { name: 'Ø§Ù„Ù‚Ù„Ù…', ayahs: 52 },
      { name: 'Ø§Ù„Ø­Ø§Ù‚Ø©', ayahs: 52 },
      { name: 'Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬', ayahs: 44 },
      { name: 'Ù†ÙˆØ­', ayahs: 28 },
      { name: 'Ø§Ù„Ø¬Ù†', ayahs: 28 },
      { name: 'Ø§Ù„Ù…Ø²Ù…Ù„', ayahs: 20 },
      { name: 'Ø§Ù„Ù…Ø¯Ø«Ø±', ayahs: 56 },
      { name: 'Ø§Ù„Ù‚ÙŠØ§Ù…Ø©', ayahs: 40 },
      { name: 'Ø§Ù„Ø¥Ù†Ø³Ø§Ù†', ayahs: 31 },
      { name: 'Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª', ayahs: 50 },
      { name: 'Ø§Ù„Ù†Ø¨Ø£', ayahs: 40 },
      { name: 'Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª', ayahs: 46 },
      { name: 'Ø¹Ø¨Ø³', ayahs: 42 },
      { name: 'Ø§Ù„ØªÙƒÙˆÙŠØ±', ayahs: 29 },
      { name: 'Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±', ayahs: 19 },
      { name: 'Ø§Ù„Ù…Ø·ÙÙÙŠÙ†', ayahs: 36 },
      { name: 'Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚', ayahs: 25 },
      { name: 'Ø§Ù„Ø¨Ø±ÙˆØ¬', ayahs: 22 },
      { name: 'Ø§Ù„Ø·Ø§Ø±Ù‚', ayahs: 17 },
      { name: 'Ø§Ù„Ø£Ø¹Ù„Ù‰', ayahs: 19 },
      { name: 'Ø§Ù„ØºØ§Ø´ÙŠØ©', ayahs: 26 },
      { name: 'Ø§Ù„ÙØ¬Ø±', ayahs: 30 },
      { name: 'Ø§Ù„Ø¨Ù„Ø¯', ayahs: 20 },
      { name: 'Ø§Ù„Ø´Ù…Ø³', ayahs: 15 },
      { name: 'Ø§Ù„Ù„ÙŠÙ„', ayahs: 21 },
      { name: 'Ø§Ù„Ø¶Ø­Ù‰', ayahs: 11 },
      { name: 'Ø§Ù„Ø´Ø±Ø­', ayahs: 8 },
      { name: 'Ø§Ù„ØªÙŠÙ†', ayahs: 8 },
      { name: 'Ø§Ù„Ø¹Ù„Ù‚', ayahs: 19 },
      { name: 'Ø§Ù„Ù‚Ø¯Ø±', ayahs: 5 },
      { name: 'Ø§Ù„Ø¨ÙŠÙ†Ø©', ayahs: 8 },
      { name: 'Ø§Ù„Ø²Ù„Ø²Ù„Ø©', ayahs: 8 },
      { name: 'Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª', ayahs: 11 },
      { name: 'Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©', ayahs: 11 },
      { name: 'Ø§Ù„ØªÙƒØ§Ø«Ø±', ayahs: 8 },
      { name: 'Ø§Ù„Ø¹ØµØ±', ayahs: 3 },
      { name: 'Ø§Ù„Ù‡Ù…Ø²Ø©', ayahs: 9 },
      { name: 'Ø§Ù„ÙÙŠÙ„', ayahs: 5 },
      { name: 'Ù‚Ø±ÙŠØ´', ayahs: 4 },
      { name: 'Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†', ayahs: 7 },
      { name: 'Ø§Ù„ÙƒÙˆØ«Ø±', ayahs: 3 },
      { name: 'Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†', ayahs: 6 },
      { name: 'Ø§Ù„Ù†ØµØ±', ayahs: 3 },
      { name: 'Ø§Ù„Ù…Ø³Ø¯', ayahs: 5 },
      { name: 'Ø§Ù„Ø¥Ø®Ù„Ø§Øµ', ayahs: 4 },
      { name: 'Ø§Ù„ÙÙ„Ù‚', ayahs: 5 },
      { name: 'Ø§Ù„Ù†Ø§Ø³', ayahs: 6 },
    ];

    function WarshTrainer() {
      const [surahStart, setSurahStart] = useState(1);
      const [surahEnd, setSurahEnd] = useState(1);
      const [ayahStart, setAyahStart] = useState(1);
      const [ayahEnd, setAyahEnd] = useState(7);
      const [reciter, setReciter] = useState('warsh_dossary');
      
      const [allVersesHtml, setAllVersesHtml] = useState([]);
      const [extractedRules, setExtractedRules] = useState(null);
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState(null);
      
      const [isPlaying, setIsPlaying] = useState(false);
      const [currentAyah, setCurrentAyah] = useState(null);
      const [playbackSpeed, setPlaybackSpeed] = useState(0.75);
      
      const [isRecording, setIsRecording] = useState(false);
      const [recordingTime, setRecordingTime] = useState(0);
      const [recordings, setRecordings] = useState([]);
      const [playingRecording, setPlayingRecording] = useState(null);
      
      const [fontSize, setFontSize] = useState(28);
      const [lineHeight, setLineHeight] = useState(2.2);
      const [verseStep, setVerseStep] = useState(5);
      const [currentPage, setCurrentPage] = useState(0);
      const [isFullscreen, setIsFullscreen] = useState(false);
      const [navStep, setNavStep] = useState(5);
      const [showLegend, setShowLegend] = useState(false);
      
      const audioRef = useRef(null);
      const userAudioRef = useRef(null);
      const mediaRecorderRef = useRef(null);
      const timerRef = useRef(null);
      const chunksRef = useRef([]);
      
      const maxAyahsStart = SURAH_DATA[surahStart]?.ayahs || 7;
      const maxAyahsEnd = SURAH_DATA[surahEnd]?.ayahs || 7;

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // COLORIZE TEXT - Apply Warsh rules character by character
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const colorizeText = (text, apiHtml = '') => {
        // If we have API HTML with tajweed tags, process those first
        if (apiHtml && apiHtml.includes('<tajweed')) {
          let html = apiHtml;
          
          // Step 1: Replace API tajweed tags with our Warsh colors
          html = html.replace(/<tajweed\s+class=["']?([^"'>\s]+)["']?>([^<]+)<\/tajweed>/g, (match, className, text) => {
            const ourRule = TAJWEED_API_MAP[className];
            if (ourRule && TAJWEED_RULES[ourRule]) {
              const color = TAJWEED_RULES[ourRule].color;
              return `<span style="color: ${color};" title="${TAJWEED_RULES[ourRule].arabic}">${text}</span>`;
            }
            return text;
          });
          
          // Step 2: Apply tafkheem to heavy letters NOT already in spans
          const parts = html.split(/(<span[^>]*>.*?<\/span>)/g);
          html = parts.map(part => {
            if (part.startsWith('<span')) return part;
            return part.replace(new RegExp(`([${TAFKHEEM_LETTERS}])`, 'g'), 
              `<span style="color: ${COLORS.TAFKHEEM};" title="ØªÙØ®ÙŠÙ…">$1</span>`
            );
          }).join('');
          
          // Remove verse end markers
          html = html.replace(/<span\s+class=["']?end["']?>([^<]+)<\/span>/g, '');
          
          return html;
        }
        
        // No API HTML - do character-by-character coloring for Warsh text
        const chars = [...text];
        const positionRules = new Map();
        
        const mark = (pos, rule) => {
          if (pos >= 0 && pos < chars.length && !positionRules.has(pos)) {
            positionRules.set(pos, rule);
          }
        };
        
        // 1. NAQL - tanween + hamzat wasl
        for (let i = 0; i < chars.length - 1; i++) {
          if (/[Ù‹ÙŒÙ]/.test(chars[i]) && chars[i+1] === 'Ù±') {
            mark(i, 'naql');
            mark(i+1, 'naql');
          }
        }
        
        // 2. TAQLIL - specific word patterns
        const textStr = chars.join('');
        for (const word of TAQLIL_PATTERNS) {
          let idx = textStr.indexOf(word);
          while (idx !== -1) {
            for (let j = idx; j < idx + [...word].length && j < chars.length; j++) {
              if (chars[j] === 'Ø§' || chars[j] === 'Ù‰') mark(j, 'taqlil');
            }
            idx = textStr.indexOf(word, idx + 1);
          }
        }
        
        // 3. TASHIL - two hamzahs meeting
        for (let i = 0; i < chars.length - 1; i++) {
          if (/[Ø£Ø¡Ø¥Ø¤Ø¦]/.test(chars[i]) && /[Ø£Ø¡Ø¥Ø¤Ø¦]/.test(chars[i+1])) {
            mark(i, 'tashil');
            mark(i+1, 'tashil');
          }
        }
        
        // 4. IBDAL - hamzah with sukoon
        for (let i = 0; i < chars.length - 1; i++) {
          if (/[Ø¤Ø¦]/.test(chars[i]) && chars[i+1] === 'Ù’') {
            mark(i, 'ibdal');
          }
        }
        
        // 5. TARQIQ RA - ra with kasra
        for (let i = 0; i < chars.length; i++) {
          if (chars[i] === 'Ø±') {
            if ((i > 0 && /[ÙÙ]/.test(chars[i-1])) || (i + 1 < chars.length && /[ÙÙ]/.test(chars[i+1]))) {
              mark(i, 'tarqiq_ra');
            }
          }
        }
        
        // 6. MADD BADAL - hamzah + madd letter
        for (let i = 0; i < chars.length - 1; i++) {
          if (/[Ø¡Ø£Ø¥]/.test(chars[i]) && MADD_LETTERS.includes(chars[i+1])) {
            mark(i, 'madd_badal');
            mark(i+1, 'madd_badal');
          }
          if (chars[i] === 'Ø¢') mark(i, 'madd_badal');
        }
        
        // 7. MADD 6 - madd letter + hamzah
        for (let i = 0; i < chars.length - 1; i++) {
          if (MADD_LETTERS.includes(chars[i])) {
            for (let j = i + 1; j < Math.min(i + 3, chars.length); j++) {
              if (/[Ø¡Ø£Ø¥Ø¤Ø¦]/.test(chars[j])) {
                if (!positionRules.has(i)) mark(i, 'madd_6');
                break;
              }
              if (!/[Ù‹ÙŒÙÙÙÙÙ‘Ù’]/.test(chars[j])) break;
            }
          }
        }
        
        // 8. GHUNNAH - noon/meem with shaddah
        for (let i = 0; i < chars.length - 1; i++) {
          if ((chars[i] === 'Ù†' || chars[i] === 'Ù…') && chars[i+1] === 'Ù‘') {
            mark(i, 'ghunnah');
          }
        }
        
        // 9. QALQALAH - qalqalah letters with sukoon or at end
        for (let i = 0; i < chars.length; i++) {
          if (QALQALAH_LETTERS.includes(chars[i])) {
            if ((i + 1 < chars.length && chars[i+1] === 'Ù’') ||
                i + 1 >= chars.length || chars[i+1] === ' ' || /[ÛÛ]/.test(chars[i+1])) {
              mark(i, 'qalqalah');
            }
          }
        }
        
        // 10. TAFKHEEM - heavy letters (lowest priority)
        for (let i = 0; i < chars.length; i++) {
          if (TAFKHEEM_LETTERS.includes(chars[i])) {
            mark(i, 'tafkheem');
          }
        }
        
        // Build HTML
        let result = '';
        for (let i = 0; i < chars.length; i++) {
          const rule = positionRules.get(i);
          if (rule && TAJWEED_RULES[rule]) {
            const r = TAJWEED_RULES[rule];
            result += `<span style="color: ${r.color};" title="${r.arabic}">${chars[i]}</span>`;
          } else {
            result += chars[i];
          }
        }
        return result;
      };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // FETCH TEXT - Uses Quran.com API with tajweed markup
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const fetchTajweedRules = async () => {
        setIsLoading(true);
        setError(null);
        
        try {
          const verses = [];
          const rules = [];
          
          for (let s = surahStart; s <= surahEnd; s++) {
            const startA = s === surahStart ? ayahStart : 1;
            const endA = s === surahEnd ? ayahEnd : (SURAH_DATA[s]?.ayahs || 1);
            
            const response = await fetch(
              `https://api.quran.com/api/v4/quran/verses/uthmani_tajweed?chapter_number=${s}`
            );
            
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            
            const json = await response.json();
            const data = json.verses || [];
            
            for (const verse of data) {
              const ayahNum = parseInt(verse.verse_key?.split(':')[1]) || 0;
              if (ayahNum < startA || ayahNum > endA) continue;
              
              const tajweedText = verse.text_uthmani_tajweed || '';
              verses.push({ key: verse.verse_key, text: tajweedText });
              
              // Extract rules from API
              const tagRegex = /<tajweed\s+class=["']?([^"'>\s]+)["']?>([^<]+)<\/tajweed>/g;
              let match;
              while ((match = tagRegex.exec(tajweedText)) !== null) {
                const apiRule = match[1];
                const arabicText = match[2];
                const ourRule = TAJWEED_API_MAP[apiRule];
                if (ourRule && TAJWEED_RULES[ourRule]) {
                  rules.push({
                    text: arabicText,
                    verse: verse.verse_key,
                    rule: ourRule,
                    arabic_rule: TAJWEED_RULES[ourRule].arabic
                  });
                }
              }
            }
          }
          
          // Remove duplicates
          const uniqueRules = rules.reduce((acc, curr) => {
            const key = `${curr.text}-${curr.rule}`;
            if (!acc.find(r => `${r.text}-${r.rule}` === key)) acc.push(curr);
            return acc;
          }, []);
          
          setExtractedRules({ rules: uniqueRules });
          
          // Colorize each verse
          const versesHtml = verses.map(v => ({
            key: v.key,
            html: colorizeText(v.text.replace(/<[^>]+>/g, ''), v.text)
          }));
          
          setAllVersesHtml(versesHtml);
          setCurrentPage(0);
          
          if (verses.length === 0) setError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢ÙŠØ§Øª');
          
        } catch (err) {
          setError('ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + err.message);
        } finally {
          setIsLoading(false);
        }
      };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // AUDIO PLAYBACK
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const getAudioUrl = (surah, ayah) => {
        const r = RECITERS[reciter];
        return `${r.baseUrl}/${surah.toString().padStart(3, '0')}${ayah.toString().padStart(3, '0')}.mp3`;
      };

      const playReference = (startSurah = surahStart, startAyah = ayahStart) => {
        if (audioRef.current) audioRef.current.pause();
        
        const audio = new Audio(getAudioUrl(startSurah, startAyah));
        audio.playbackRate = playbackSpeed;
        audioRef.current = audio;
        setCurrentAyah(startAyah);
        
        audio.onplay = () => setIsPlaying(true);
        audio.onended = () => {
          const isEnd = startSurah > surahEnd || (startSurah === surahEnd && startAyah >= ayahEnd);
          if (!isEnd) {
            const nextAyah = startAyah + 1;
            const maxAyahs = SURAH_DATA[startSurah]?.ayahs || 1;
            if (nextAyah <= maxAyahs && (startSurah < surahEnd || nextAyah <= ayahEnd)) {
              setTimeout(() => playReference(startSurah, nextAyah), 300);
              return;
            } else if (startSurah < surahEnd) {
              setTimeout(() => playReference(startSurah + 1, 1), 300);
              return;
            }
          }
          setIsPlaying(false);
          setCurrentAyah(null);
        };
        audio.onerror = () => {
          setError('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª');
          setIsPlaying(false);
        };
        audio.play().catch(() => setError('ØªØ¹Ø°Ø± Ø§Ù„ØªØ´ØºÙŠÙ„'));
      };

      const stopReference = () => {
        if (audioRef.current) {
          audioRef.current.pause();
          setIsPlaying(false);
          setCurrentAyah(null);
        }
      };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // RECORDING
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const startRecording = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorderRef.current = new MediaRecorder(stream);
          chunksRef.current = [];
          
          mediaRecorderRef.current.ondataavailable = (e) => {
            if (e.data.size > 0) chunksRef.current.push(e.data);
          };
          
          mediaRecorderRef.current.onstop = () => {
            const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            setRecordings(prev => [...prev.slice(-9), {
              url, surahStart, surahEnd, ayahStart, ayahEnd, time: Date.now()
            }]);
          };
          
          mediaRecorderRef.current.start();
          setIsRecording(true);
          setRecordingTime(0);
          timerRef.current = setInterval(() => setRecordingTime(t => t + 1), 1000);
        } catch (err) {
          setError('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');
        }
      };

      const stopRecording = () => {
        if (mediaRecorderRef.current && isRecording) {
          mediaRecorderRef.current.stop();
          mediaRecorderRef.current.stream.getTracks().forEach(t => t.stop());
          setIsRecording(false);
          clearInterval(timerRef.current);
        }
      };

      const playRecording = (rec, idx) => {
        if (userAudioRef.current) userAudioRef.current.pause();
        const audio = new Audio(rec.url);
        userAudioRef.current = audio;
        setPlayingRecording(idx);
        audio.onended = () => setPlayingRecording(null);
        audio.play();
      };

      const formatTime = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;

      // Navigation
      const navigateVerses = (dir) => {
        const step = navStep * dir;
        let newSurah = surahStart;
        let newAyah = ayahStart + step;
        
        while (newAyah > (SURAH_DATA[newSurah]?.ayahs || 1) && newSurah < 114) {
          newAyah -= SURAH_DATA[newSurah]?.ayahs || 1;
          newSurah++;
        }
        while (newAyah < 1 && newSurah > 1) {
          newSurah--;
          newAyah += SURAH_DATA[newSurah]?.ayahs || 1;
        }
        
        newAyah = Math.max(1, Math.min(newAyah, SURAH_DATA[newSurah]?.ayahs || 1));
        let endAyah = Math.min(newAyah + navStep - 1, SURAH_DATA[newSurah]?.ayahs || 1);
        
        setSurahStart(newSurah);
        setSurahEnd(newSurah);
        setAyahStart(newAyah);
        setAyahEnd(endAyah);
        setAllVersesHtml([]);
        setCurrentPage(0);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-amber-100 via-orange-50 to-yellow-100 p-4">
          <div className="max-w-4xl mx-auto">
            {/* Header */}
            <div className="text-center py-4">
              <h1 className="text-3xl font-bold text-amber-900 font-arabic">Ù…Ø¯Ø±Ø¨ Ø§Ù„ØªØ¬ÙˆÙŠØ¯</h1>
              <p className="text-amber-700 font-arabic">Ø±ÙˆØ§ÙŠØ© ÙˆØ±Ø´ Ø¹Ù† Ù†Ø§ÙØ¹</p>
            </div>

            {error && (
              <div className="bg-red-100 border border-red-400 rounded-xl p-3 mb-4 text-red-700 font-arabic">
                {error}
                <button onClick={() => setError(null)} className="mr-2 underline">Ø¥ØºÙ„Ø§Ù‚</button>
              </div>
            )}

            {/* Color Legend */}
            <div className="bg-white/80 rounded-xl p-4 mb-4 shadow">
              <button 
                onClick={() => setShowLegend(!showLegend)}
                className="w-full flex justify-between items-center text-amber-800 font-bold font-arabic"
              >
                <span>ğŸ¨ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Ù¡Ù  Ù‚ÙˆØ§Ø¹Ø¯)</span>
                <span>{showLegend ? 'â–¼' : 'â—€'}</span>
              </button>
              
              {showLegend && (
                <div className="grid grid-cols-2 gap-2 mt-3">
                  {COLOR_LEGEND.map((item, i) => (
                    <div key={i} className="flex items-center gap-2 p-2 bg-amber-50 rounded">
                      <div className="w-4 h-4 rounded-full" style={{ backgroundColor: item.color }} />
                      <span className="font-arabic text-sm">{item.arabic}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Selection */}
            <div className="bg-white/80 rounded-xl p-4 mb-4 shadow">
              <div className="text-amber-800 font-bold font-arabic mb-3">Ø§Ø®ØªØ± Ø§Ù„Ø¢ÙŠØ§Øª</div>
              
              <div className="grid grid-cols-3 gap-3 mb-3">
                <select 
                  value={surahStart}
                  onChange={(e) => {
                    const num = +e.target.value;
                    setSurahStart(num);
                    setSurahEnd(num);
                    setAyahStart(1);
                    setAyahEnd(Math.min(7, SURAH_DATA[num]?.ayahs || 7));
                    setAllVersesHtml([]);
                  }}
                  className="col-span-2 bg-amber-50 border border-amber-300 rounded-lg p-3 font-arabic"
                >
                  {SURAH_DATA.slice(1).map((s, i) => (
                    <option key={i+1} value={i+1}>{i+1}. {s.name}</option>
                  ))}
                </select>
                <div className="flex gap-2">
                  <input
                    type="number"
                    value={ayahStart}
                    onChange={(e) => setAyahStart(Math.max(1, Math.min(maxAyahsStart, +e.target.value)))}
                    min={1}
                    max={maxAyahsStart}
                    className="w-full bg-amber-50 border border-amber-300 rounded-lg p-3 text-center"
                  />
                  <input
                    type="number"
                    value={ayahEnd}
                    onChange={(e) => setAyahEnd(Math.max(ayahStart, Math.min(maxAyahsEnd, +e.target.value)))}
                    min={ayahStart}
                    max={maxAyahsEnd}
                    className="w-full bg-amber-50 border border-amber-300 rounded-lg p-3 text-center"
                  />
                </div>
              </div>

              {/* Navigation */}
              <div className="border-t border-amber-200 pt-3">
                <div className="text-amber-700 text-xs font-arabic mb-2">Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ù€:</div>
                <div className="flex gap-2 mb-3">
                  {[1, 5, 10, 20].map(n => (
                    <button
                      key={n}
                      onClick={() => setNavStep(n)}
                      className={`px-4 py-2 rounded-lg font-bold ${navStep === n ? 'bg-amber-600 text-white' : 'bg-amber-100'}`}
                    >{n}</button>
                  ))}
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => navigateVerses(-1)}
                    disabled={surahStart === 1 && ayahStart === 1}
                    className="flex-1 py-3 bg-slate-600 disabled:bg-gray-300 rounded-xl text-white font-bold font-arabic"
                  >â†’ Ø§Ù„Ø³Ø§Ø¨Ù‚ {navStep}</button>
                  <button
                    onClick={() => navigateVerses(1)}
                    disabled={surahEnd === 114 && ayahEnd === SURAH_DATA[114]?.ayahs}
                    className="flex-1 py-3 bg-slate-600 disabled:bg-gray-300 rounded-xl text-white font-bold font-arabic"
                  >Ø§Ù„ØªØ§Ù„ÙŠ {navStep} â†</button>
                </div>
              </div>
            </div>

            {/* Load Button */}
            <button 
              onClick={fetchTajweedRules}
              disabled={isLoading}
              className="w-full py-4 bg-amber-600 hover:bg-amber-500 disabled:bg-gray-400 rounded-xl text-white text-lg font-bold font-arabic mb-4"
            >
              {isLoading ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' : 'ğŸ“– ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ ÙˆØ§Ù„ØªØ¬ÙˆÙŠØ¯'}
            </button>

            {/* Verse Display */}
            {allVersesHtml.length > 0 && (
              <div className={`${isFullscreen ? 'fixed inset-0 z-50 bg-white p-4 overflow-auto' : 'bg-white rounded-xl p-4 mb-4 shadow'}`}>
                <div className="flex flex-wrap gap-2 mb-3 pb-3 border-b border-amber-100">
                  <button
                    onClick={() => setIsFullscreen(!isFullscreen)}
                    className="px-3 py-2 bg-slate-600 text-white rounded-lg font-arabic text-sm"
                  >{isFullscreen ? 'âœ• Ø¥ØºÙ„Ø§Ù‚' : 'â›¶ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©'}</button>
                  
                  <div className="flex items-center gap-1 bg-amber-50 rounded-lg p-1">
                    <span className="text-amber-600 text-xs px-1">Ø­Ø¬Ù…</span>
                    <button onClick={() => setFontSize(Math.max(16, fontSize - 2))} className="w-8 h-8 bg-amber-100 rounded font-bold">âˆ’</button>
                    <span className="w-8 text-center text-sm">{fontSize}</span>
                    <button onClick={() => setFontSize(Math.min(56, fontSize + 2))} className="w-8 h-8 bg-amber-100 rounded font-bold">+</button>
                  </div>
                  
                  <div className="flex items-center gap-1 bg-amber-50 rounded-lg p-1">
                    <span className="text-amber-600 text-xs px-1">ØªØ¨Ø§Ø¹Ø¯</span>
                    <button onClick={() => setLineHeight(Math.max(1.2, lineHeight - 0.2))} className="w-8 h-8 bg-amber-100 rounded font-bold">âˆ’</button>
                    <button onClick={() => setLineHeight(Math.min(4, lineHeight + 0.2))} className="w-8 h-8 bg-amber-100 rounded font-bold">+</button>
                  </div>
                </div>
                
                <div className="flex gap-1 mb-3 overflow-x-auto">
                  <span className="text-amber-600 text-xs font-arabic whitespace-nowrap py-2">Ø¹Ø±Ø¶:</span>
                  {[1, 3, 5, 7, 10, 'Ø§Ù„ÙƒÙ„'].map(n => (
                    <button
                      key={n}
                      onClick={() => { setVerseStep(n === 'Ø§Ù„ÙƒÙ„' ? allVersesHtml.length : n); setCurrentPage(0); }}
                      className={`px-3 py-2 rounded-lg text-sm font-arabic whitespace-nowrap ${
                        (n === 'Ø§Ù„ÙƒÙ„' && verseStep >= allVersesHtml.length) || verseStep === n 
                          ? 'bg-amber-600 text-white' : 'bg-amber-100'
                      }`}
                    >{n}</button>
                  ))}
                </div>

                {allVersesHtml.length > verseStep && (
                  <div className="flex justify-between items-center mb-3">
                    <button
                      onClick={() => setCurrentPage(Math.max(0, currentPage - 1))}
                      disabled={currentPage === 0}
                      className="px-4 py-2 bg-amber-600 disabled:bg-gray-300 text-white rounded-lg font-arabic"
                    >â†’ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <span className="text-amber-700 text-sm">
                      {currentPage * verseStep + 1}-{Math.min((currentPage + 1) * verseStep, allVersesHtml.length)} / {allVersesHtml.length}
                    </span>
                    <button
                      onClick={() => setCurrentPage(Math.min(Math.ceil(allVersesHtml.length / verseStep) - 1, currentPage + 1))}
                      disabled={(currentPage + 1) * verseStep >= allVersesHtml.length}
                      className="px-4 py-2 bg-amber-600 disabled:bg-gray-300 text-white rounded-lg font-arabic"
                    >Ø§Ù„ØªØ§Ù„ÙŠ â†</button>
                  </div>
                )}

                <div 
                  className="font-arabic leading-loose"
                  style={{ fontSize: `${fontSize}px`, lineHeight: lineHeight }}
                >
                  {allVersesHtml
                    .slice(currentPage * verseStep, (currentPage + 1) * verseStep)
                    .map((v, i) => {
                      const ayahNum = parseInt(v.key.split(':')[1]);
                      return (
                        <span key={i} className={currentAyah === ayahNum ? 'bg-amber-100 rounded px-1' : ''}>
                          <span dangerouslySetInnerHTML={{ __html: v.html }} />
                          <span className="text-amber-400 text-sm mx-1">ï´¿{v.key.split(':')[1]}ï´¾</span>
                        </span>
                      );
                    })}
                </div>
                
                {/* Quick color key */}
                <div className="flex flex-wrap gap-2 mt-3 pt-3 border-t border-amber-100">
                  <span className="text-xs font-arabic" style={{color: COLORS.NAQL}}>â–  Ù†Ù‚Ù„</span>
                  <span className="text-xs font-arabic" style={{color: COLORS.TAQLIL}}>â–  ØªÙ‚Ù„ÙŠÙ„</span>
                  <span className="text-xs font-arabic" style={{color: COLORS.TASHIL}}>â–  ØªØ³Ù‡ÙŠÙ„</span>
                  <span className="text-xs font-arabic" style={{color: COLORS.IBDAL}}>â–  Ø¥Ø¨Ø¯Ø§Ù„</span>
                  <span className="text-xs font-arabic" style={{color: COLORS.TARQIQ_RA}}>â–  ØªØ±Ù‚ÙŠÙ‚</span>
                  <span className="text-xs font-arabic" style={{color: COLORS.MADD_BADAL}}>â–  Ù…Ø¯ Ø§Ù„Ø¨Ø¯Ù„</span>
                  <span className="text-xs font-arabic" style={{color: COLORS.MADD_6}}>â–  Ù…Ø¯ Ù¦</span>
                  <span className="text-xs font-arabic" style={{color: COLORS.GHUNNAH}}>â–  ØºÙ†Ø©</span>
                  <span className="text-xs font-arabic" style={{color: COLORS.QALQALAH}}>â–  Ù‚Ù„Ù‚Ù„Ø©</span>
                  <span className="text-xs font-arabic" style={{color: COLORS.TAFKHEEM}}>â–  ØªÙØ®ÙŠÙ…</span>
                </div>
              </div>
            )}

            {/* Audio Controls */}
            <div className="bg-white/80 rounded-xl p-4 mb-4 shadow">
              <div className="text-amber-800 font-bold font-arabic mb-3">Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹</div>
              
              <select 
                value={reciter}
                onChange={(e) => setReciter(e.target.value)}
                className="w-full bg-amber-50 border border-amber-300 rounded-lg p-3 font-arabic mb-3"
              >
                {Object.entries(RECITERS).map(([k, v]) => (
                  <option key={k} value={k}>{v.name}</option>
                ))}
              </select>
              
              <div className="flex gap-2 mb-3">
                {[0.5, 0.75, 1].map(s => (
                  <button
                    key={s}
                    onClick={() => setPlaybackSpeed(s)}
                    className={`flex-1 py-2 rounded-lg ${playbackSpeed === s ? 'bg-amber-500 text-white' : 'bg-amber-100'}`}
                  >{s}x</button>
                ))}
              </div>
              
              <button
                onClick={isPlaying ? stopReference : () => playReference()}
                className={`w-full py-4 rounded-xl text-white text-lg font-bold font-arabic ${
                  isPlaying ? 'bg-orange-500' : 'bg-amber-600'
                }`}
              >
                {isPlaying ? `â¸ Ø¥ÙŠÙ‚Ø§Ù (${currentAyah})` : 'â–¶ï¸ ØªØ´ØºÙŠÙ„'}
              </button>
            </div>

            {/* Recording */}
            <div className="bg-white/80 rounded-xl p-4 mb-4 shadow">
              <div className="text-amber-800 font-bold font-arabic mb-3">Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
              
              <button
                onClick={isRecording ? stopRecording : startRecording}
                className={`w-full py-4 rounded-xl text-white text-xl font-bold font-arabic ${
                  isRecording ? 'bg-red-500 animate-pulse' : 'bg-amber-600'
                }`}
              >
                {isRecording ? `â¹ Ø¥ÙŠÙ‚Ø§Ù (${formatTime(recordingTime)})` : 'ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„'}
              </button>
              
              {recordings.length > 0 && (
                <div className="mt-3 space-y-2">
                  {recordings.slice().reverse().map((rec, i) => (
                    <div key={rec.time} className="flex items-center gap-2 bg-amber-50 rounded-lg p-2">
                      <button
                        onClick={() => playingRecording === i ? userAudioRef.current?.pause() : playRecording(rec, i)}
                        className={`w-10 h-10 rounded-full flex items-center justify-center ${
                          playingRecording === i ? 'bg-orange-500' : 'bg-amber-500'
                        } text-white`}
                      >
                        {playingRecording === i ? 'â¸' : 'â–¶ï¸'}
                      </button>
                      <div className="flex-1 font-arabic text-sm">
                        {SURAH_DATA[rec.surahStart]?.name} {rec.ayahStart}-{rec.ayahEnd}
                      </div>
                      <a 
                        href={rec.url} 
                        download={`${rec.surahStart}-${rec.ayahStart}-${rec.ayahEnd}.webm`}
                        className="px-3 py-1 bg-green-500 text-white rounded text-sm"
                      >â¬‡ï¸</a>
                    </div>
                  ))}
                </div>
              )}
            </div>

          </div>
        </div>
      );
    }

    ReactDOM.render(<WarshTrainer />, document.getElementById('root'));
  </script>
</body>
</html>
